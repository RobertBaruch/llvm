# Part 2: ELF output

## About ELF

ELF (Executable and Linkable Format) is a file format for executable files, object files, and so on. Basically it's sections of machine code with annotations. One of these annotations is for relocation or linking, which finalizes values in the machine code which are not known at time of compilation. For example, a symbol in an object file may actually live in another object file, so until the location of that symbol is known, a placeholder has to be used. The placeholder later gets *fixed up* to its final value.

One of the elements in the ELF header is `e_machine`, which is a 2-byte value encoding the architecture the ELF file is for. Not only does this help prevent execution on inappropriate architectures, but it is also a signal to utility programs like `objdump` for how to disassemble or otherwise decode flags and data in the ELF file.

There are some 240 assigned `e_machine` values, include reserved values, as of Feb 2019. They had been maintained by SCO until their bankruptcy, and is now maintained by Xinuos. The [latest draft](http://www.sco/com/developers/gabi/latest/ch4.eheader.html) as of Feb 2019 was marked June 2013, although ten more have been added since that revision (personal communication).

The `e_machine` designation for the MCS6502 was requested via email to `registry@xinuos.com`, and the response came back in only a few hours: `EM_MCS6502` now has number 254.

The purpose of this step is to add the new `e_machine` value and other ELF enums associated with the new target.

# The changed files

* `include/llvm/BinaryFormat/ELF.h`
* `include/llvm/Object/ELFObjectFile.h`
* `include/llvm/module.modulemap`
* `lib/Object/ELF.cpp`
* `lib/Object/ELFYAML.cpp`
* `tools/llvm-readobj/ELFDumper.cpp`
* (Add) `include/llvm/BinaryFormat/ELFRelocs/MCS6502.def`

## Modifications to `ELF.h`

* Add the new `EM_MCS6502` enum.
* Include relocation flags. This will eventually tell us how to replace unknown values in ELF files.
  ```
  // ELF relocation types for MCS6502
  enum {
  #include "ELFRelocs/MCS6502.def"
  };
  ``` 

## Modifications to `ELFObjectFile.h`

* Add a mapping from the ELF enumeration to a name in `getFileFormatName()`.
* Add a mapping from the enumeration to the architecture enum in `getArch()`. We check the `e_ident` part of the ELF header to ensure it is a 32-bit style ELF file. This doesn't mean 32-bit pointers, it indicates the file's capacity.

## Modifications to `module.modulemap`

* Add a `textual header` line for the soon to be created `BinaryFormat/ELFRelocs/MCS6502.def` file in the `LLVM_BinaryFormat` module.

## Modifications to `ELF.cpp`

* Add a mapping in `getELFRelocationTypeName()` from the ELF enumeration to all the cases to be defined in `BinaryFormat/ELFRelocs/MCS6502.def`.
  ```
    case ELF::EM_MCS6502:
      switch (Type) {
  #include "llvm/BinaryFormat/ELFRelocs/MCS6502.def"
      default:
        break;
      }
      break;
  ```

## Modifications to `ELFYAML.cpp`

`YAML` is a human-readable data serialization protocol. This is a helper file to generate YAML for an ELF file.

* Add a case for the ELF enumeration in `ScalarEnumerationTraits<ELFYAML::ELF_EM>::enumeration()`.
* Add a case for the ELF enumeration in `ScalarBitSetTraits<ELFYAML::ELF_EF>::bitset()` that just breaks.
* Add a case for the ELF enumeration in `ScalarEnumerationTraits<ELFYAML::ELF_REL>::enumeration()`.
  
## Modifications to `ELFDumper.cpp`

* Add a mapping in `ElfMachineType[]` for the ELF enumeration to a descriptive string.

## Adding `MCS6502.def`

This file will just contain one value, meaning no change. Later, when we have different types of 

```
#ifndef ELF_RELOC
#error "ELF_RELOC must be defined"
#endif

ELF_RELOC(R_MCS6502_NONE, 0)
```

# Tests

For testing, we add these files:

* `test/Object/MCS6502/lit.local.cfg`
* `test/Object/MCS6502/elf-flags.yaml`

This will test that we can turn a YAML representation of an ELF MCS6502 object file into an actual object file, and back again.

## Adding `lit.local.cfg`

This allows `lit`, the LLVM test program, to recognize that this directory should be added to tests if the MCS6502 target is being built.

```
if not 'MCS6502' in config.root.targets:
  config.unsupported = True
```

## Adding `elf-flags.yaml`

This file is written in the `lit` script language. It runs three programs. The output of the last two are checked against the prefixed strings in the file.

# Compile

At this stage we can compile to ensure we haven't introduced any syntax errors:

```
cmake --build .
```

However, at this point we cannot test because LLVM will not recognize `MCS6502` as a target yet. The next patch will add minimal code, enough to get a build running so we can test the ELF flags.
