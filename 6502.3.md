# Part 3: Minimal skeleton

This part defines the bare minimum required to add MCS6502 to the list of experimental targets and get it to build.

# Added files

* `lib/Target/LLVMBuild.txt`: the list of target subdirectories
* `lib/Target/MCS6502/CMakeLists.txt`: the list of subdirectories within the target, and the list of files to process in this directory.
* `lib/Target/MCS6502/LLVMBuild.txt`: defines groups of files and dependencies
* `lib/Target/MCS6502/MCS6502TargetMachine.h/cpp`: a subclass of `LLVMTargetMachine`
* `lib/Target/MCS6502/TargetInfo/CMakeLists.txt`: `CMakeLists` for the TargetInfo subdirectory
* `lib/Target/MCS6502/TargetInfo/LLVMBuild.txt`: `LLVMBuild` for the TargetInfo subdirectory
* `lib/Target/MCS6502/TargetInfo/MCS6502TargetInfo.cpp`: More stuff

## Modifications to `lib/Target/LLVMBuild.txt`

* Simply adding the MCS6502 subdirectory to the list is enough.

## Adding `lib/Target/MCS6502` build files

* For `LLVMBuild.txt`, we set up two components, an `MCS6502` *target group* that is part of the built-in `Target` group, and an `MCS6502CodeGen` *library* that is part of the `MCS6502` group. So the hierarchy basically looks like this:
  * Target (group)
    * MCS6502 (group)
      * MCS6502CodeGen (library)
* The `CMakeFiles.txt` file adds files to the target, `MCS6502CodeGen`. There's only one file right now, `MCS6502TargetMachine.cpp`.

## Adding `MCS6502TargetMachine.h/cpp`

The minimal subclass of `LLVMTargetMachine` requires a constructor, a method to create compiler passes, and a method to return a `TargetLoweringObjectFile`, whatever that is.

There must also be an `LLVMInitialize<Target>Target()` hook for LLVM to call which has to register the target machine.

## Adding `MCS6502/TargetInfo` build files

We create an `MCS6502Info` library which is part of the `MCS6502` group, and add the file `MCS6502TargetInfo.cpp` to the list of files to compile.

## Adding `MCS6502TargetInfo.cpp`

This file:
* holds the singleton `Target` for the MCS6502.
* includes an `LLVMInitializeMCS6502TargetInfo()` hook for LLVM to call which has to register the target information.
* includes an `LLVMInitializeMCS6502TargetMC()` hook for LLVM to call which currently does nothing (but must exist).

# Building and test

We can now include the target in the list of experimental targets to build:

```
cmake -G Ninja -DCMAKE_BUILD_TYPE=Debug -DBUILD_SHARED_LIBS=True \
  -DLLVM_OPTIMIZED_TABLEGEN=True -DLLVM_BUILD_TESTS=True \
  -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++ \
  -DLLVM_EXPERIMENTAL_TARGETS_TO_BUILD="RISCV;MCS6502" \
  -DLLVM_TARGETS_TO_BUILD=WebAssembly ../llvmsrc/llvm

cmake --build .

bin/llvm-lit -v ../llvmsrc/llvm/test/Object/MCS6502
```

If the test fails, you can manually run the commands in the test file. `%s` means the file itself, while `%t` is a temporary output file.
